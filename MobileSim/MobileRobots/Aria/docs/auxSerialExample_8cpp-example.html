<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Aria: auxSerialExample.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>auxSerialExample.cpp</h1>  </div>
</div>
<div class="contents">
<p>Demonstrates the use of a robot packet handler to recieve data from a device attached to the robot microcontroller's auxilliary serial port.</p>
<p>This example shows how to use the GETAUX command and how to recieve SERAUX serial port data. To use this example, you must have the auxilliary serial port AUX1 on the microcontroller (inside the robot) connected to a device that is sending text data.</p>
<p>You can connect AUX1 to a computer through an RS-232 cable with a NULL modem adapter, and run a program such as minicom (Linux) or HyperTerminal (Windows). Then just type to send data to the AUX1 port. Configure minicom or HyperTerminal to have the following serial port settings: 9600 baud 8 data bits, 1 stop bit, no parity No flow control (not hardware, not software)!</p>
<p>This program creates a packet handler function (getAuxPrinter) and adds it to the <a class="el" href="classArRobot.html" title="Central class for communicating with and operating the robot.">ArRobot</a> object. All packets recieved from the robot are passed to all packet handlers. getAuxPrinter() checks whether the packet is an SERAUX packet, and if so, prints out the data contained within the packet. If a newline or carriage return character is recieved, then it sends a command to send data back out through the AUX serial port. The packet handler then sends a GETAUX command to the robot to request more data.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &quot;Aria.h&quot;</span>

<span class="comment">// our robot object</span>
<a name="_a0"></a><a class="code" href="classArRobot.html" title="Central class for communicating with and operating the robot.">ArRobot</a> *robot;

<span class="keywordtype">bool</span> getAuxPrinter(<a name="_a1"></a><a class="code" href="classArRobotPacket.html" title="Represents the packets sent to the robot as well as those received from it.">ArRobotPacket</a> *packet)
{
  <span class="keywordtype">char</span> c;
  
  <span class="comment">// If this is not an aux. serial data packet, then return false to allow other</span>
  <span class="comment">// packet handlers to recieve the packet. The packet type ID numbers are found</span>
  <span class="comment">// in the description of the GETAUX commands in the robot manual.</span>
  <span class="keywordflow">if</span> (packet-&gt;<a name="a2"></a><a class="code" href="classArRobotPacket.html#a0e41b0bbe73260cff302094500a51b7d" title="returns the ID of the packet">getID</a>() != 0xb0) <span class="comment">// 0xB8 is SERAUXpac. SERAUX2pac is 0xB8, SERAUX3pac is 0xC8.</span>
    <span class="keywordflow">return</span> <span class="keyword">false</span>;

  <span class="comment">// Get bytes out of the packet buffer and print them.</span>
  <span class="keywordflow">while</span> (packet-&gt;<a name="a3"></a><a class="code" href="classArBasePacket.html#a2657ef599121ffd23c4fca509093eda2" title="Gets how far into the packet that has been read.">getReadLength</a> () &lt; packet-&gt;<a name="a4"></a><a class="code" href="classArBasePacket.html#ac02587ced816dd142d74fae2929ec4b2" title="Gets the total length of the packet.">getLength</a>() - 2)
  {
    c = packet-&gt;<a name="a5"></a><a class="code" href="classArBasePacket.html#a32d7bab938c3fcc1929890282eb5bec6" title="Gets a ArTypes::UByte from the buffer.">bufToUByte</a>();
    <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;\r&#39;</span> || c == <span class="charliteral">&#39;\n&#39;</span>)
    {
      putchar(<span class="charliteral">&#39;\n&#39;</span>);

      <span class="comment">// How to send data to the serial port. See robot manual</span>
      <span class="comment">// (but note that TTY2 is for the AUX1 port, TTY3 for AUX2, etc.)</span>
      robot-&gt;<a name="a6"></a><a class="code" href="classArRobot.html#af0b32b39e44d1175b9cffa3f010459a1" title="Sends a command to the robot with a length-prefixed string for argument.">comStr</a>(<a name="a7"></a><a class="code" href="classArCommands.html#a9a31f904a95bbc31d8b33c6637100cc4a51de296ec889c02c88c0bf98b11c414a" title="string, send string argument to serial dev connected to aux1">ArCommands::TTY2</a>, <span class="stringliteral">&quot;Hello, World!\n\r&quot;</span>);
    }
    <span class="keywordflow">else</span>
      putchar(c);
    fflush(stdout);
  }

  
  <span class="comment">// Request more data:</span>
  robot-&gt;<a name="a8"></a><a class="code" href="classArRobot.html#aceef80a6274fb34aafcc422e4b1778c1" title="Sends a command to the robot with an int for argument.">comInt</a>(<a name="a9"></a><a class="code" href="classArCommands.html#a9a31f904a95bbc31d8b33c6637100cc4a10e72ab2eec33fe56d8db1042c462e93" title="int, requests 1-200 bytes from aux1 serial channel, 0 flush">ArCommands::GETAUX</a>, 1);

  <span class="comment">// To request 12 bytes at a time, specify that instead:</span>
  <span class="comment">//robot-&gt;comInt(ArCommands::GETAUX, 12);</span>

  <span class="comment">// If you wanted to recieve information from the second aux. serial port, use</span>
  <span class="comment">// the GETAUX2 command instead; but the packet returned will also have a</span>
  <span class="comment">// different type ID.</span>
  <span class="comment">//robot-&gt;comInt(ArCommands::GETAUX2, 1);</span>
  

  <span class="comment">// Return true to indicate to ArRobot that we have handled this packet.</span>
  <span class="keywordflow">return</span> <span class="keyword">true</span>;
}
  

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) 
{
  <a name="a10"></a><a class="code" href="classAria.html#ad99c16b5d947229d9f8e1c5b2d4cdd73" title="Initialize Aria global data struture and perform OS-specific initialization, including adding OS sign...">Aria::init</a>();

  <a name="_a11"></a><a class="code" href="classArArgumentParser.html" title="Class for parsing arguments.">ArArgumentParser</a> argParser(&amp;argc, argv);
  <a name="_a12"></a><a class="code" href="classArSimpleConnector.html" title="Legacy connector for robot and laser.">ArSimpleConnector</a> conn(&amp;argParser);
  argParser.loadDefaultArguments();
  <span class="keywordflow">if</span>(!<a name="a13"></a><a class="code" href="classAria.html#a1b090c01d88bb420b8cf8e0384d25ee1" title="Parses the arguments for the program (calls all the callbacks added with addParseArgsCB()).">Aria::parseArgs</a>() || !argParser.checkHelpAndWarnUnparsed())
  {
    <a name="a14"></a><a class="code" href="classAria.html#a10d71f3d4d0cf7f38c58a1f749f64a42" title="Logs all the options for the program (Calls all the callbacks added with addLogOptionsCB()).">Aria::logOptions</a>();
    <span class="keywordflow">return</span> 1;
  }
  
  <span class="comment">// This is a global pointer so the global functions can use it.</span>
  robot = <span class="keyword">new</span> <a class="code" href="classArRobot.html" title="Central class for communicating with and operating the robot.">ArRobot</a>;

  <span class="comment">// functor for the packet handler</span>
  <a name="_a15"></a><a class="code" href="classArGlobalRetFunctor1.html" title="Functor for a global function with 1 parameter and return value.">ArGlobalRetFunctor1&lt;bool, ArRobotPacket *&gt;</a> getAuxCB(&amp;getAuxPrinter);
  <span class="comment">// add our packet handler as the first one in the list</span>
  robot-&gt;<a name="a16"></a><a class="code" href="classArRobot.html#a9710774cf8be7f146ca58f83dd076e3f" title="Adds a packet handler to the list of packet handlers.">addPacketHandler</a>(&amp;getAuxCB, <a name="a17"></a><a class="code" href="classArListPos.html#adb42d52c70a646c5698c5513cd25bbd0a7573a55fbcdb54b1768e9ce574407d15" title="place item first in the list">ArListPos::FIRST</a>);

  <span class="comment">// Connect to the robot</span>
  <span class="keywordflow">if</span>(!conn.connectRobot(robot))
  {
      <a name="a18"></a><a class="code" href="classArLog.html#a43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a name="a19"></a><a class="code" href="classArLog.html#ac8cc0fb3aa323ab2a1c21340fdd1dce3a012daf6573594f91242f8dd7c02eb74b" title="Use terse logging.">ArLog::Terse</a>, <span class="stringliteral">&quot;getAuxExample: Error connecting to the robot.&quot;</span>);
      <span class="keywordflow">return</span> 2;
  }

  <a class="code" href="classArLog.html#a43a8b3789126c818f390f24bdbceccce" title="Log a message, with formatting and variable number of arguments.">ArLog::log</a>(<a name="a20"></a><a class="code" href="classArLog.html#ac8cc0fb3aa323ab2a1c21340fdd1dce3a7040faf60eeb155eaa85d439b1066ca1" title="Use normal logging.">ArLog::Normal</a>, <span class="stringliteral">&quot;getAuxExample: Connected to the robot. Sending command to change AUX1 baud rate to 9600...&quot;</span>);
  robot-&gt;<a class="code" href="classArRobot.html#aceef80a6274fb34aafcc422e4b1778c1" title="Sends a command to the robot with an int for argument.">comInt</a>(<a name="a21"></a><a class="code" href="classArCommands.html#a9a31f904a95bbc31d8b33c6637100cc4acbcdf7c6c50666489b721290d9440c34" title="int, set baud rate for Aux1 - 0=9600, 1=19200, 2=38400, 3=57600, 4=115200">ArCommands::AUX1BAUD</a>, 0); <span class="comment">// See robot manual</span>

  <span class="comment">// Send the first GETAUX request</span>
  robot-&gt;<a class="code" href="classArRobot.html#aceef80a6274fb34aafcc422e4b1778c1" title="Sends a command to the robot with an int for argument.">comInt</a>(<a class="code" href="classArCommands.html#a9a31f904a95bbc31d8b33c6637100cc4a10e72ab2eec33fe56d8db1042c462e93" title="int, requests 1-200 bytes from aux1 serial channel, 0 flush">ArCommands::GETAUX</a>, 1);

  <span class="comment">// If you wanted to recieve information from the second aux. serial port, use</span>
  <span class="comment">// the GETAUX2 command instead; but the packet returned will also have a</span>
  <span class="comment">// different type ID.</span>
  <span class="comment">//robot-&gt;comInt(ArCommands::GETAUX2, 1);</span>

  <span class="comment">// run the robot until disconnect, then shutdown and exit.</span>
  robot-&gt;<a name="a22"></a><a class="code" href="classArRobot.html#afb40bb581fa61eb08a542840e4264e26" title="Starts the instance to do processing in this thread.">run</a>(<span class="keyword">true</span>);
  <a name="a23"></a><a class="code" href="classAria.html#a184602a2b3799d61569ec55dd9508450" title="Shutdown all Aria processes/threads.">Aria::shutdown</a>();
  <span class="keywordflow">return</span> 0;  
}

</pre></div> </div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Aug 23 2011 16:44:26 for Aria by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
